# Система Виртуального Терминала

Безопасная система виртуального терминала, предоставляющая изолированные Docker-контейнеры для пользователей SSH. Система создает новый Docker-контейнер для каждой SSH-сессии, обеспечивая изоляцию и управление ресурсами.

## Возможности

- Безопасный SSH-доступ с аутентификацией по паролю
- Изолированный Docker-контейнер для каждой пользовательской сессии
- Ограничение ресурсов для контейнеров (CPU и память)
- Система управления пользователями
- Автоматическая очистка контейнеров после завершения сессии
- Поддержка интерактивной оболочки с правильной эмуляцией терминала
- Обработка таймаутов сессии

## Зависимости

### Системные требования
- Python 3.7+
- Docker Engine
- SSH server

### Установка Docker
#### Ubuntu/Debian:
```bash
# Обновление списка пакетов
sudo apt-get update

# Установка необходимых пакетов
sudo apt-get install -y \
    apt-transport-https \
    ca-certificates \
    curl \
    gnupg \
    lsb-release

# Добавление официального GPG-ключа Docker
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

# Добавление репозитория Docker
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# Установка Docker
sudo apt-get update
sudo apt-get install -y docker-ce docker-ce-cli containerd.io

# Добавление текущего пользователя в группу docker
sudo usermod -aG docker $USER

# Запуск Docker
sudo systemctl start docker
sudo systemctl enable docker
```

#### CentOS:
```bash
# Установка необходимых пакетов
sudo yum install -y yum-utils

# Добавление репозитория Docker
sudo yum-config-manager \
    --add-repo \
    https://download.docker.com/linux/centos/docker-ce.repo

# Установка Docker
sudo yum install -y docker-ce docker-ce-cli containerd.io

# Добавление текущего пользователя в группу docker
sudo usermod -aG docker $USER

# Запуск Docker
sudo systemctl start docker
sudo systemctl enable docker
```

### Python пакеты
```bash
pip install asyncssh
pip install asyncio
pip install bcrypt
pip install docker
```

## Установка

1. Клонируйте репозиторий:
```bash
git clone [repository-url]
cd virtual-terminal
```

2. Установите требуемые Python пакеты:
```bash
pip install -r requirements.txt
```

3. Загрузите базовый образ Ubuntu:
```bash
docker pull ubuntu:20.04
```

4. Сгенерируйте SSH ключ хоста:
```bash
ssh-keygen -t rsa -b 4096 -f ssh_host_key -N ''
```

5. Создайте первого пользователя:
```bash
python manage_users.py <имя_пользователя> <пароль>
```

## Конфигурация

Основные параметры конфигурации определены в начале файла `virtual_terminal.py`:

- `SSH_PORT`: порт SSH сервера (по умолчанию: 2222)
- `DOCKER_IMAGE`: базовый Docker образ для контейнеров (по умолчанию: ubuntu:20.04)
- `MEMORY_LIMIT`: ограничение памяти контейнера (по умолчанию: 512m)
- `CPU_QUOTA`: квота CPU контейнера (по умолчанию: 50% одного ядра CPU)
- `IO_TIMEOUT`: таймаут операций ввода-вывода (по умолчанию: 60 секунд)

## Использование

1. Запустите сервер виртуального терминала:
```bash
python virtual_terminal.py
```

2. Подключитесь к серверу через SSH:
```bash
ssh -o PreferredAuthentications=password -o PubkeyAuthentication=no -p 2222 username@hostname
```

### Управление пользователями

Добавление новых пользователей с помощью скрипта управления:
```bash
python manage_users.py <имя_пользователя> <пароль>
```

Пользователи хранятся в файле `users.txt` с паролями, хешированными с помощью bcrypt.

## Тестирование

Система поставляется со скриптом тестирования `test_virtual_terminal.sh`, который проверяет все основные функции системы:

```bash
./test_virtual_terminal.sh
```

### Что тестирует скрипт:

1. **Подготовка окружения:**
   - Генерация SSH-ключей хоста
   - Создание тестового пользователя
   - Очистка предыдущих тестовых контейнеров

2. **Функциональное тестирование:**
   - Создание и настройка тестового пользователя
   - Запуск сервера виртуального терминала
   - Проверка SSH-подключения и аутентификации
   - Проверка создания Docker-контейнера
   - Верификация ограничений ресурсов контейнера

3. **Проверка безопасности:**
   - Корректность работы аутентификации
   - Изоляция контейнера
   - Правильность применения ограничений ресурсов

4. **Очистка:**
   - Автоматическая очистка тестовых данных
   - Удаление тестовых контейнеров
   - Удаление временных файлов

### Запуск тестов:
```bash
# Сделать скрипт исполняемым
chmod +x test_virtual_terminal.sh

# Запустить тесты
./test_virtual_terminal.sh
```

### Интерпретация результатов:
- ✓ (зеленый) - тест пройден
- ✗ (красный) - тест не пройден

В случае ошибки, скрипт предоставит подробную информацию о том, какой именно тест не прошел.

## Архитектура системы

### Компоненты

1. **SSH Сервер (`virtual_terminal.py`)**
   - Обработка SSH подключений
   - Управление аутентификацией пользователей
   - Создание и управление Docker контейнерами
   - Обработка ввода-вывода терминала

2. **Управление пользователями (`manage_users.py`)**
   - Создание пользователей
   - Хеширование паролей
   - Управление базой данных пользователей

3. **Управление контейнерами**
   - Автоматическое создание контейнера для каждой сессии
   - Ограничение ресурсов
   - Корректное завершение работы контейнера
   - Обработка изменений размера терминала

### Функции безопасности

- Изолированные Docker контейнеры для каждой сессии
- Безопасное хеширование паролей с помощью bcrypt
- Ограничения ресурсов предотвращают DoS-атаки
- Автоматическая очистка сессий
- Обработка таймаутов неактивных сессий

### Управление ресурсами

Каждый контейнер ограничен:
- 512МБ памяти
- 50% использования одного ядра CPU
- Автоматическое завершение после окончания сессии

## Устранение неполадок

### Частые проблемы

1. **Отказ в доступе**
   - Проверьте права Docker
   - Проверьте существование пользователя в users.txt
   - Проверьте правильность пароля
   - Попробуйте подключиться с использованием: -o PreferredAuthentications=password -o PubkeyAuthentication=no

2. **Отказ в подключении**
   - Убедитесь, что сервер запущен
   - Проверьте доступность SSH_PORT
   - Проверьте наличие ключа хоста

3. **Ошибка создания контейнера**
   - Проверьте статус демона Docker
   - Проверьте доступность ресурсов памяти/CPU
   - Проверьте наличие Docker образа

4. **Ошибки при сборке контейнера**
   - Попробуйте обновить Docker Compose до актуальной версии (желательнее через pip3 install docker-compose, предварительно удалив текущую версию)
   - Попробуйте очистить кеш Docker и пересоберите образ

### Логи

- Проверьте системные логи для проблем с SSH
- Логи Docker для проблем с контейнерами
- Логи приложения для проблем с аутентификацией и сессиями

## Рекомендации по безопасности

1. Измените порт SSH по умолчанию в продакшене
2. Используйте сложные пароли
3. Регулярно обновляйте базовый образ Docker
4. Следите за системными ресурсами